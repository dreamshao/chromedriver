name: Force Update Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    # 触发条件：包含 v 或 V
    if: |
      contains(github.event.head_commit.message, 'v') || 
      contains(github.event.head_commit.message, 'V') ||
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史以操作 Tag

      - name: Extract Version
        id: get_version
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          VERSION=$(echo "$COMMIT_MSG" | grep -oEi 'v[0-9.]+' | head -1 || echo "")
          if [ -z "$VERSION" ]; then
            VERSION="v-manual"
          fi
          echo "VERSION_TAG=$VERSION" >> $GITHUB_OUTPUT

      # --- 核心步骤：如果存在则删除旧的 Release 和 Tag ---
      - name: Delete Old Release and Tag
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION_TAG }}
          # 哪怕不存在也不要报错，直接继续
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.MY_PAT }}

      # --- 核心步骤：重新发布最新的文件 ---
      - name: Upload New Assets to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION_TAG }}
          files: "*.zip"
          # 开启覆盖模式作为双重保险
          overwrite: true 
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.MY_PAT }}
