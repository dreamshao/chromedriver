name: Incremental Release Manager

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    if: |
      contains(github.event.head_commit.message, 'v') || 
      contains(github.event.head_commit.message, 'V') ||
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync Files to "main" Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: "main"
        run: |
          # 1. 确保 Release 存在
          if ! gh release view $RELEASE_TAG > /dev/null 2>&1; then
            echo "[*] 创建新的 Release: $RELEASE_TAG"
            gh release create $RELEASE_TAG --title "Driver Collection" --notes "增量更新仓库"
          fi

          # 2. 获取清单（增加容错处理）
          echo "[*] 正在同步远程文件列表..."
          gh release view $RELEASE_TAG --json assets --jq '.assets[].name' > remote_assets.txt || touch remote_assets.txt

          # 3. 逐一校验并上传
          # 使用 find 处理可能包含空格的文件名
          find . -maxdepth 1 -name "*.zip" -type f | while read -r file; do
            filename=$(basename "$file")
            
            if grep -qxF "$filename" remote_assets.txt; then
              echo "[跳过] $filename 已存在于 Release 中"
            else
              echo "[尝试上传] $filename ..."
              # 使用 --clobber 会覆盖，不加则会报错。
              # 我们配合 || true 即使服务端瞬时报错（例如并发冲突）也不中断后续文件上传
              gh release upload $RELEASE_TAG "$file" || echo "[警告] $filename 上传失败（可能已存在或网络波动）"
            fi
          done

      - name: Final Summary
        run: echo "同步任务执行完毕。"
