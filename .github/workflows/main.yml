name: Force Update Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    # 触发条件：提交信息包含 v 或 V，或者是手动触发
    if: |
      contains(github.event.head_commit.message, 'v') || 
      contains(github.event.head_commit.message, 'V') ||
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史以操作标签

      - name: Extract Version
        id: get_version
        run: |
          # 从提交信息提取版本号 (如 v145)
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          VERSION=$(echo "$COMMIT_MSG" | grep -oEi 'v[0-9.]+' | head -1 || echo "")
          
          # 手动触发或未匹配到时的备用方案
          if [ -z "$VERSION" ]; then
            VERSION="v-manual"
          fi
          
          echo "VERSION_TAG=$VERSION" >> $GITHUB_OUTPUT
          echo "[*] Target Version: $VERSION"

      - name: Delete Old Release and Tag
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          # 修正：通过 github_token 参数传递，不再使用环境变量
          github_token: ${{ secrets.MY_PAT }}
          tag_name: ${{ steps.get_version.outputs.VERSION_TAG }}
          delete_release: true
        # 即使没有旧版本可以删除（第一次发布），也继续执行后续步骤
        continue-on-error: true

      - name: Upload New Assets to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION_TAG }}
          files: "*.zip"
          overwrite: true # 双重保险，确保覆盖
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.MY_PAT }}
